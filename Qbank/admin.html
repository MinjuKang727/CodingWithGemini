<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Q-Bank ê´€ë¦¬ì ì„¼í„°</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .selector-box { display: flex; gap: 10px; background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        select, input, textarea { padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        .q-card { border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .common-area { background: #fff3e0; padding: 15px; border-radius: 8px; border: 1px solid #ffe0b2; margin-bottom: 15px; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        
        .side-save-bar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-save-fixed {
            background: var(--success);
            color: white;
            padding: 20px 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 16px;
            transition: 0.3s;
        }

        .btn-save-fixed:hover {
            background: #219150;
            transform: scale(1.05);
        }

        .btn-top {
            position: fixed;
            right: 25px;
            bottom: 25px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }   
    </style>
</head>
<body>

<div id="view-login" class="container" style="max-width:400px; text-align:center; margin-top:100px;">
    <h2>ğŸ”’ ê´€ë¦¬ì ì¸ì¦</h2>
    <button id="btn-google-login" style="background:#4285F4; color:white; border:none; padding:15px; width:100%; border-radius:5px; font-weight:bold; cursor:pointer;">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
</div>

<div id="view-editor" class="container hidden">
    <div class="admin-header">
        <h1>ğŸ› ï¸ ë¬¸ì œ í¸ì§‘ê¸° (ê³µí†µì§€ë¬¸ ì§€ì›)</h1>
        <button onclick="handleLogout()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>   
    </div>

    <div class="selector-box">
        <select id="sel-subject" style="flex:1;"><option value="">ê³¼ëª© ì„ íƒ</option></select>
        <select id="sel-exam" style="flex:1;"><option value="">íšŒì°¨ ì„ íƒ</option></select>
        <button onclick="loadExamData()" style="background:var(--primary); color:white; border:none; padding:0 20px; border-radius:5px; cursor:pointer;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        
        <input type="text" id="batch-ans" placeholder="ì •ë‹µ ì—°ì† ì…ë ¥ (ì˜ˆ: 12A43)" style="width:200px;">
        <button onclick="applyBatchAnswers()" style="background:var(--success); color:white; border:none; padding:0 10px; border-radius:5px; cursor:pointer;">ì ìš©</button>
    </div>

    <div id="editor-list"></div>

    <div id="fixed-save-area" class="side-save-bar">    
        <button class="btn-save-fixed" onclick="saveToFirebase()">SAVE</button>
    </div>

    <button class="btn-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">TOP</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCNnZltTeWoOodD7zmonx34RivTz6i8s04",
        authDomain: "qbank-f4821.firebaseapp.com",
        databaseURL: "https://qbank-f4821-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "qbank-f4821",
        storageBucket: "qbank-f4821.firebasestorage.app",
        messagingSenderId: "150452150398",
        appId: "1:150452150398:web:a65a9ddfb8250c2895782f",
        measurementId: "G-Z7527YKNKF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    const adminEmails = ["minjukang727@gmail.com"];
    let allData = {}, currentPath = "";

    document.getElementById('btn-google-login').addEventListener('click', () => signInWithPopup(auth, provider));

    onAuthStateChanged(auth, (user) => {
        if (user && adminEmails.includes(user.email)) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('hidden');

            onValue(ref(db, 'quizzes'), (snap) => {
                const quizzesData = snap.val() || {};
                allData = quizzesData;
                const selSub = document.getElementById('sel-subject');
                selSub.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>';
                Object.keys(quizzesData).forEach(subjectName => {
                    selSub.innerHTML += `<option value="${subjectName}">${subjectName}</option>`;
                });
            });
        }
    });

    document.getElementById('sel-subject').onchange = (e) => {
        const sub = e.target.value;
        const selExam = document.getElementById('sel-exam');
        selExam.innerHTML = '<option value="">íšŒì°¨ ì„ íƒ</option>';
        if(!allData[sub]) return;
        Object.keys(allData[sub]).forEach(y => Object.keys(allData[sub][y]).forEach(t => {
            selExam.innerHTML += `<option value="${y}/${t}">${y}ë…„ ${t}</option>`;
        }));
    };

    // ì •ë‹µ ì¼ê´„ ì ìš© í•¨ìˆ˜
    window.applyBatchAnswers = () => {
        const batchInput = document.getElementById('batch-ans').value.trim();
        if (!batchInput) return alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        // ê³µë°± ì œê±° í›„ í•œ ê¸€ìì”© ë¶„ë¦¬ (ìˆ«ì, ì•ŒíŒŒë²³ ëª¨ë‘ í¬í•¨)
        const answers = batchInput.replace(/\s+/g, '').split('');

        answers.forEach((ans, i) => {
            const inputField = document.getElementById(`ans-${i}`);
            if (inputField) {
                inputField.value = ans; // ê° ë¬¸ì œ ì •ë‹µì¹¸ì— í•œ ê¸€ìì”© ì…ë ¥
            }
        });
        alert(`${answers.length}ê°œì˜ ì •ë‹µì´ ìˆœì„œëŒ€ë¡œ ë°°ë¶„ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };

    window.loadExamData = () => {
        const sub = document.getElementById('sel-subject').value;
        const path = document.getElementById('sel-exam').value;
        if(!sub || !path) return alert("ì„ íƒ í›„ í´ë¦­í•˜ì„¸ìš”.");

        currentPath = `${sub}/${path}`;
        const pathParts = path.split('/');
        const questions = pathParts.reduce((o, k) => o[k], allData[sub]);
        
        const listArea = document.getElementById('editor-list');
        listArea.innerHTML = "";

        questions.forEach((q, i) => {
            const card = document.createElement('div');
            card.className = 'q-card';
            card.innerHTML = `
                <div class="common-area">
                    <label>
                        <input type="checkbox" id="is-com-${i}" ${q.isCommon ? 'checked' : ''} onchange="toggleCom(${i})"> 
                        <b>ê³µí†µ ì§€ë¬¸ ì„¤ì •</b>
                    </label>
                    <div id="com-range-box-${i}" style="margin-top:10px; ${q.isCommon ? '' : 'display:none;'}">
                        ì ìš© ë²”ìœ„: 
                        <input type="number" id="com-start-${i}" value="${q.comStart || i+1}" style="width:50px;"> ë²ˆ ~ 
                        <input type="number" id="com-end-${i}" value="${q.comEnd || i+1}" style="width:50px;"> ë²ˆ
                    </div>
                    <textarea id="com-txt-${i}" style="width:100%; margin-top:10px; ${q.isCommon ? '' : 'display:none;'}" rows="4" placeholder="ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">${q.commonText || ''}</textarea>
                </div>

                <div style="margin-top:15px;">
                    <b>Q${i+1} ë¬¸ì œ ë‚´ìš©:</b><br>
                    <textarea id="q-txt-${i}" style="width:100%; margin-top:5px;" rows="2">${q.question}</textarea>
                </div>

                <div class="opt-grid">
                    ${[0,1,2,3].map(oi => `
                        <div>
                            ${oi+1}) <input type="text" id="opt-${i}-${oi}" value="${q.options[oi] || ''}" style="width:80%;">
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top:10px;">
                    <b>ì •ë‹µ:</b> 
                    <input type="text" id="ans-${i}" value="${q.answer}" style="width:50px; text-align:center;">
                </div>

                <div style="margin-top:10px;">
                    <b>í•´ì„¤:</b><br>
                    <textarea id="com-comment-${i}" style="width:100%; margin-top:5px;" rows="2">${q.commentary || ''}</textarea>
                </div>
            `;
            listArea.appendChild(card);
        });
    };

    window.toggleCom = (i) => {
        const isChecked = document.getElementById(`is-com-${i}`).checked;
        document.getElementById(`com-range-box-${i}`).style.display = isChecked ? 'block' : 'none';
        document.getElementById(`com-txt-${i}`).style.display = isChecked ? 'block' : 'none';
    };

    window.saveToFirebase = async () => {
        if (!currentPath) return alert("âš ï¸ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.");
        if(!confirm("ìˆ˜ì •ëœ ë‚´ìš©ì„ DBì— ìµœì¢… ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        const count = document.querySelectorAll('.q-card').length; 
        const updated = [];

        try {
            for(let i=0; i<count; i++) {
                updated.push({
                    isCommon: document.getElementById(`is-com-${i}`).checked,
                    comStart: parseInt(document.getElementById(`com-start-${i}`).value) || 0,
                    comEnd: parseInt(document.getElementById(`com-end-${i}`).value) || 0,
                    commonText: document.getElementById(`com-txt-${i}`).value,
                    question: document.getElementById(`q-txt-${i}`).value,
                    options: [0,1,2,3].map(oi => document.getElementById(`opt-${i}-${oi}`).value),
                    answer: document.getElementById(`ans-${i}`).value.trim(), 
                    commentary: document.getElementById(`com-comment-${i}`).value
                });
            }

            await set(ref(db, `quizzes/${currentPath}`), updated);
            alert("âœ… ì €ì¥ ì™„ë£Œ!");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
        }
    };

    window.handleLogout = () => {
        signOut(auth).then(() => location.reload());
    };
</script>
</body>
</html>