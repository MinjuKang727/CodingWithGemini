<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰ - ì—°ê²° ë³µêµ¬</title>
    <style>
        :root { --knou-blue: #004a94; --gold: #ffd700; --bg: #f4f7f9; --border: #dee2e6; --wrong: #e74c3c; --correct: #27ae60; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); margin: 0; padding: 0; overflow: hidden; }
        .hidden { display: none !important; }

        /* í™ˆ í™”ë©´ */
        .home-container { max-width: 1000px; margin: 30px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); height: 85vh; overflow-y: auto; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 40px; }
        
        /* ì‹œí—˜ í™”ë©´ */
        .exam-page { display: flex; flex-direction: column; height: 100vh; width: 100vw; background: #fff; }
        .exam-header { background: var(--knou-blue); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .exam-body { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; overflow-y: auto; padding: 30px 50px; background: white; scroll-behavior: smooth; }
        .omr-area { width: 380px; background: #f8f9fa; border-left: 2px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .omr-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .omr-footer { padding: 15px; background: #fff; border-top: 1px solid var(--border); }

        /* ë¬¸ì œì˜ ê³µí†µì§€ë¬¸ ìŠ¤íƒ€ì¼ */
        .common-text-box {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            line-height: 1.6;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            font-weight: 500;
            color: #333;
        }
        .common-tag {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        /* ë¬¸ì œ UI */
        .q-block { position: relative; padding: 25px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 40px; background: #fff; }
        .idx-btn { width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; background: white; }
        .idx-btn.checked { background: var(--gold); border-color: #e6c200; font-weight: bold; }
        .idx-btn.checked::after { content: 'âœ“'; color: #333; }
        .opt-item { padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; margin: 8px 0; cursor: pointer; transition: 0.2s; }
        .opt-item.selected { background: #e7f1ff; border-color: var(--knou-blue); font-weight: bold; }
        
        /* OMR í…Œì´ë¸” */
        .omr-table { width: 100%; border-collapse: collapse; background: white; }
        .omr-table tr { border-bottom: 1px solid #eee; height: 45px; }
        .omr-num-cell { width: 40px; font-weight: bold; text-align: center; color: var(--knou-blue); cursor: pointer; }
        .omr-circle { width: 28px; height: 28px; border: 1px solid #777; border-radius: 50%; display: inline-block; text-align: center; line-height: 28px; cursor: pointer; font-size: 0.85rem; margin: 0 2px; }
        .omr-circle.marked { background: #333; color: white; border-color: #333; }

        .btn { padding: 10px 18px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-blue { background: var(--knou-blue); color: white; }
        .btn-dark { background: #333; color: white; }
        
        .history-card { background: #fdfdfd; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .nav-footer { position: sticky; bottom: 0; background: white; border-top: 1px solid #eee; padding: 15px; display: flex; justify-content: center; gap: 30px; align-items: center; }
    </style>
</head>
<body>

<div id="setup-page" class="home-container">
    <h1 style="text-align:center; color:var(--knou-blue); margin-bottom: 30px;">KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</h1>
    <div class="grid-layout">
        <div>
            <h3>ğŸ›  ì‹œí—˜ ì„¤ì •</h3>
            <label><b>ê³¼ëª© ì„ íƒ</b></label>
            <select id="sel-subject" style="width:100%; padding:12px; margin:10px 0; border-radius:5px; border:1px solid #ccc;">
                <option value="">ë°ì´í„° ë¡œë”© ì¤‘...</option>
            </select>
            
            <label><b>ì‹œí—˜ íšŒì°¨</b></label>
            <div id="exam-radio-container" style="margin-top:8px; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; background:#fafafa; border-radius:5px;">
                ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.
            </div>
            
            <div id="random-options" class="hidden" style="margin:15px 0; background:#eef2f7; padding:15px; border-radius:8px;">
                <label><b>ì¶”ì¶œ ë¬¸í•­ ìˆ˜</b></label>
                <div style="margin-top:8px; display:flex; gap:10px;">
                    <label><input type="radio" name="rd-cnt" value="15"> 15</label>
                    <label><input type="radio" name="rd-cnt" value="25" checked> 25</label>
                    <label><input type="radio" name="rd-cnt" value="40"> 40</label>
                    <label><input type="radio" name="rd-cnt" value="50"> 50</label>
                </div>
            </div>

            <label><b>ì‘ì‹œ ë°©ì‹</b></label>
            <select id="sel-study-mode" style="width:100%; padding:12px; margin:10px 0; border-radius:5px;">
                <option value="normal-all">ì¼ë°˜: ì „ì²´ ë¬¸ì œ í•œë²ˆì— ë³´ê¸° (OMR)</option>
                <option value="normal-step">ì¼ë°˜: 1ë¬¸ì œì”© ë³´ê¸° (OMR)</option>
                <option value="study">ì—°ìŠµ: í•´ì„¤ ë³´ë©° í’€ê¸° (1ë¬¸ì œì”©)</option>
            </select>

            <div style="margin-bottom:20px; background:#fff3e0; padding:12px; border-radius:8px;">
                <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="extra-time-chk"> <b>ì‹œí—˜ ì‹œê°„ ì—°ì¥ (íŠ¹ë³„ê´€ë¦¬ëŒ€ìƒ)</b>
                </label>
            </div>
            <button class="btn btn-blue" style="width:100%; height:55px;" onclick="prepareExam()">ì‹œí—˜ ì‹œì‘</button>
        </div>
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">ğŸ“œ ìµœê·¼ í’€ì´ ê¸°ë¡</h3>
                <button class="btn" style="background: #e74c3c; color: white; padding: 5px 10px; font-size: 0.8rem;" onclick="clearHistory()">ê¸°ë¡ ì´ˆê¸°í™”</button>
            </div>
            <div id="history-container"></div>
        </div>
    </div>
</div>

<div id="exam-page" class="exam-page hidden">
    <div class="exam-header">
        <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="exitToHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
        <div id="exam-title" style="font-weight:bold;"></div>
        <div id="timer-display" style="font-size:1.4rem; color:var(--gold); font-weight:bold;">00:00</div>
    </div>
    <div class="exam-body">
        <div class="question-area" id="q-container"></div>
        <div class="omr-area" id="omr-panel">
            <div class="omr-scroll">
                <h4 style="text-align:center; margin-top:0;">OMR ë‹µì•ˆì§€</h4>
                <table class="omr-table">
                    <tbody id="omr-rows-target"></tbody>
                </table>
            </div>
            <div class="omr-footer"><button class="btn btn-dark" style="width:100%;" onclick="confirmSubmit()">ìµœì¢… ì œì¶œ</button></div>
        </div>
    </div>
    <div id="step-nav" class="nav-footer hidden">
        <button class="btn btn-dark" onclick="moveIdx(-1)">ì´ì „</button>
        <div id="step-count" style="font-weight:bold;"></div>
        <button class="btn btn-dark" onclick="moveIdx(1)">ë‹¤ìŒ</button>
    </div>
</div>

<div id="result-page" class="hidden" style="overflow-y:auto; height:100vh; background:#fff; padding:40px;">
    <div style="max-width:850px; margin:0 auto;">
        <h1 style="text-align:center; color:var(--knou-blue);">ì‹œí—˜ ê²°ê³¼</h1>
        <div id="result-summary" style="background:#f8f9fa; padding:25px; border-radius:12px; margin-bottom:30px; display:grid; grid-template-columns:1fr 1fr; gap:15px; border:1px solid #eee;"></div>
        <h3 style="color:var(--wrong);">âŒ ì˜¤ë‹µ í™•ì¸</h3>
        <div id="wrong-detail-list"></div>
        <button class="btn btn-blue" style="width:100%; margin-top:30px;" onclick="location.reload()">í™ˆìœ¼ë¡œ</button>
    </div>
</div>

<div id="review-page" class="hidden" style="overflow-y:auto; height:100vh; background:#fff; padding:40px;">
    <div style="max-width:850px; margin:0 auto;">
        <button class="btn btn-dark" onclick="closeReview()">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <h1 id="review-title" style="text-align:center; color:var(--knou-blue); margin-top:20px;"></h1>
        <div id="review-summary" style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:30px; border:1px solid #eee; display:flex; justify-content:space-around; font-weight:bold;"></div>
        
        <h3 style="color:var(--wrong); border-bottom:2px solid var(--wrong); padding-bottom:10px;">âŒ ë‹¤ì‹œ ë³´ê¸° (ì˜¤ë‹µ ë° ì „ì²´ ë³´ê¸°)</h3>
        <div id="review-detail-list"></div>
        
        <button class="btn btn-blue" style="width:100%; margin-top:30px;" onclick="closeReview()">í™•ì¸ ì™„ë£Œ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://qbank-f4821-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let quizData = {}, currentQs = [], userAnswers = {}, indexMarks = {}, currentIdx = 0;
    let examInfo = { sub: "", title: "", mode: "" };
    let timeLeft = 0, initialTime = 0, timerInterval = null;

    async function init() {
        renderHistory();
        const subSel = document.getElementById('sel-subject');
        try {
            const snapshot = await get(ref(db, '/'));
            if (snapshot.exists()) {
                quizData = snapshot.val();
                updateSubjectList();
            } else {
                subSel.innerHTML = '<option>ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</option>';
            }
        } catch (error) {
            subSel.innerHTML = '<option>ì—°ê²° ì˜¤ë¥˜</option>';
        }
        onValue(ref(db, '/'), (snap) => {
            if(snap.exists()) { quizData = snap.val(); updateSubjectList(); }
        });
    }

    function updateSubjectList() {
        const subSel = document.getElementById('sel-subject');
        const subjects = Object.keys(quizData);
        if (subjects.length > 0) {
            subSel.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>';
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                subSel.appendChild(opt);
            });
        }
    }

    document.getElementById('sel-subject').onchange = (e) => {
        const sub = e.target.value;
        const cont = document.getElementById('exam-radio-container');
        if(!sub || !quizData[sub]) { cont.innerHTML = "íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
        cont.innerHTML = `<label style="display:block; margin:5px 0;"><input type="radio" name="exam-sel" value="random" onchange="toggleRandom(true)"> ğŸ² ì „ì²´ ëœë¤ ê¸°ì¶œ</label>`;
        Object.keys(quizData[sub]).forEach(y => {
            Object.keys(quizData[sub][y]).forEach(t => {
                cont.innerHTML += `<label style="display:block; margin:5px 0;"><input type="radio" name="exam-sel" value="${y}|${t}" onchange="toggleRandom(false)"> ${y}ë…„ ${t}</label>`;
            });
        });
    };

    window.toggleRandom = (isRand) => document.getElementById('random-options').classList.toggle('hidden', !isRand);
    window.exitToHome = () => { if(confirm("ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); };

    window.prepareExam = () => {
        const sub = document.getElementById('sel-subject').value;
        const sel = document.querySelector('input[name="exam-sel"]:checked');
        if(!sub || !sel) return alert("ê³¼ëª©ê³¼ íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

        examInfo.sub = sub;
        examInfo.mode = document.getElementById('sel-study-mode').value;
        userAnswers = {}; indexMarks = {}; currentIdx = 0;

        if(sel.value === 'random') {
            const cnt = parseInt(document.querySelector('input[name="rd-cnt"]:checked').value);
            let pool = [];
            Object.values(quizData[sub]).forEach(y => Object.values(y).forEach(l => pool = pool.concat(l)));
            currentQs = pool.sort(() => Math.random() - 0.5).slice(0, cnt);
            examInfo.title = `ëœë¤ ${cnt}ë¬¸í•­`;
        } else {
            const [y, t] = sel.value.split('|');
            currentQs = quizData[sub][y][t];
            examInfo.title = `${y}ë…„ ${t}`;
        }

        const isExtra = document.getElementById('extra-time-chk').checked;
        let base = (currentQs.length <= 15) ? 15 : (currentQs.length <= 25) ? 25 : 50;
        initialTime = (base + (isExtra ? 10 : 0)) * 60;
        timeLeft = initialTime;

        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('exam-page').classList.remove('hidden');
        document.getElementById('exam-title').innerText = `[${sub}] ${examInfo.title}`;
        document.getElementById('omr-panel').classList.toggle('hidden', examInfo.mode === 'study');
        document.getElementById('step-nav').classList.toggle('hidden', examInfo.mode === 'normal-all');

        startTimer();
        renderExam();
    };

    function renderExam() {
        const qCont = document.getElementById('q-container');
        qCont.innerHTML = '';
        
        // í˜„ì¬ ë³´ì—¬ì¤„ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ê²°ì • (ì „ì²´ë³´ê¸° vs 1ë¬¸ì œì”©)
        const list = (examInfo.mode === 'normal-all') ? currentQs : [currentQs[currentIdx]];
        
        list.forEach((q, i) => {
            const num = (examInfo.mode === 'normal-all') ? i + 1 : currentIdx + 1;
            const block = document.createElement('div');
            block.className = 'q-block';
            block.id = `q-row-${num}`;

            // --- [ì¶”ê°€] ê³µí†µ ì§€ë¬¸ ë¡œì§ ì‹œì‘ ---
            let commonHtml = '';
            // í˜„ì¬ ë¬¸ì œ ë²ˆí˜¸(num)ê°€ ì–´ëŠ ë¬¸ì œì˜ ê³µí†µì§€ë¬¸ ë²”ìœ„(comStart ~ comEnd)ì— ì†í•˜ëŠ”ì§€ ê²€ìƒ‰
            const commonSource = currentQs.find(item => 
                item.isCommon && (num >= item.comStart && num <= item.comEnd)
            );

            if (commonSource) {
                commonHtml = `
                    <div class="common-text-box">
                        <div class="common-tag">ì§€ë¬¸ ì°¸ì¡° (${commonSource.comStart}~${commonSource.comEnd})</div>
                        <div style="white-space: pre-wrap;">${commonSource.commonText}</div>
                    </div>
                `;
            }
            // --- [ì¶”ê°€] ê³µí†µ ì§€ë¬¸ ë¡œì§ ë ---

            block.innerHTML = `
                ${commonHtml} 
                <div style="position:absolute; top:15px; left:15px;">
                    <div class="idx-btn ${indexMarks[num]?'checked':''}" onclick="toggleIdx(${num})"></div>
                </div>
                <div style="margin-left:35px;">
                    <div style="font-weight:bold; margin-bottom:15px;">${num}. ${q.question}</div>
                    ${q.options.map((opt, oi) => `
                        <div class="opt-item ${userAnswers[num]==oi+1?'selected':''}" onclick="mark(${num}, ${oi+1})">
                            ${oi+1}) ${opt}
                        </div>
                    `).join('')}
                    <div id="study-res-${num}"></div>
                    ${examInfo.mode==='study' ? `
                        <button class="btn btn-blue" style="width:100%; margin-top:10px;" 
                                onclick="checkStudy(${num}, ${q.answer}, '${(q.commentary||'').replace(/'/g, "\\'")}')">
                            ì •ë‹µ í™•ì¸
                        </button>` : ''}
                </div>`;
            qCont.appendChild(block);
        });

        if(examInfo.mode !== 'study') renderOMR();
        if(examInfo.mode !== 'normal-all') document.getElementById('step-count').innerText = `${currentIdx+1} / ${currentQs.length}`;
    }

    function renderOMR() {
        const target = document.getElementById('omr-rows-target');
        target.innerHTML = '';
        currentQs.forEach((_, i) => {
            const n = i + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="omr-num-cell" onclick="scrollToQ(${n})">${n}</td><td style="text-align:center;">${[1,2,3,4,5].map(v => `<div class="omr-circle ${userAnswers[n]==v?'marked':''}" onclick="mark(${n},${v})">${v}</div>`).join('')}</td><td style="text-align:center;"><div class="idx-btn ${indexMarks[n]?'checked':''}" onclick="toggleIdx(${n})"></div></td>`;
            target.appendChild(tr);
        });
    }

    window.mark = (n, v) => { userAnswers[n] = v; renderExam(); };
    window.toggleIdx = (n) => { indexMarks[n] = !indexMarks[n]; renderExam(); };
    window.scrollToQ = (n) => { if(examInfo.mode === 'normal-all') document.getElementById(`q-row-${n}`).scrollIntoView({ behavior: 'smooth' }); else { currentIdx = n - 1; renderExam(); } };
    window.moveIdx = (dir) => { const next = currentIdx + dir; if(next >= 0 && next < currentQs.length) { currentIdx = next; renderExam(); } };

    window.checkStudy = (n, ans, comm) => {
        if(!userAnswers[n]) return alert("ë‹µì•ˆì„ ì„ íƒí•˜ì„¸ìš”.");
        const isR = String(userAnswers[n]) === String(ans);
        document.getElementById(`study-res-${n}`).innerHTML = `<div style="padding:10px; margin-top:10px; background:#f0f0f0; border-radius:5px;"><b>${isR?'â­• ì •ë‹µ':'âŒ ì˜¤ë‹µ'} (ì •ë‹µ: ${ans})</b><br>${comm}</div>`;
    };

    function startTimer() { timerInterval = setInterval(() => { timeLeft--; const m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(timeLeft <= 0) { clearInterval(timerInterval); showResults(); } }, 1000); }
    window.confirmSubmit = () => { if(confirm("ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { clearInterval(timerInterval); showResults(); } };

    function showResults() {
        let correct = 0;
        let wrongIndices = []; // ë¬¸í•­ ë²ˆí˜¸ë§Œ ë‹´ì„ ë°°ì—´

        currentQs.forEach((q, i) => {
            const n = i + 1;
            const uAns = userAnswers[n];
            if (String(uAns) === String(q.answer)) {
                correct++;
            } else {
                // [ìˆ˜ì •] ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ì§€ ì•Šê³  ë²ˆí˜¸ì™€ ë‚´ ë‹µì•ˆë§Œ ì €ì¥
                wrongIndices.push({
                    n: n,           // ë¬¸í•­ ë²ˆí˜¸
                    user: uAns || "ë¯¸í‘œê¸°" // ë‚´ê°€ ì“´ ë‹µ
                });
            }
        });

        const score = Math.round((correct / currentQs.length) * 100);
        
        // [í•µì‹¬] ì €ì¥ ë°ì´í„° ê²½ëŸ‰í™”
        const record = {
            date: new Date().toLocaleString(),
            sub: examInfo.sub,      // ê³¼ëª© (ì¡°íšŒ í‚¤)
            title: examInfo.title,  // íšŒì°¨ (ì¡°íšŒ í‚¤)
            score: score,
            wrongs: wrongIndices,   // ì¸ë±ìŠ¤ ì •ë³´ë§Œ í¬í•¨
            isRandom: examInfo.title.includes("ëœë¤") // ëœë¤ ì‹œí—˜ ì—¬ë¶€ ì²´í¬
        };

        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        history.unshift(record);
        localStorage.setItem('knou_history', JSON.stringify(history.slice(0, 15))); // ìµœëŒ€ 15ê°œ ìœ ì§€

        document.getElementById('exam-page').classList.add('hidden');
        document.getElementById('result-page').classList.remove('hidden');
        
        // ê²°ê³¼ì°½ì—ì„œëŠ” í˜„ì¬ ë©”ëª¨ë¦¬ì— ë¡œë“œëœ currentQsë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ ì¦‰ì‹œ ë Œë”ë§
        renderReviewList('wrong-detail-list', record); 
        renderHistory();
    }

    function renderReviewList(targetId, record) {
        const target = document.getElementById(targetId);
        let sourceQs = [];
        if (!record.isRandom) {
            const [year, term] = record.title.split('ë…„ ');
            if (quizData[record.sub] && quizData[record.sub][year] && quizData[record.sub][year][term]) {
                sourceQs = quizData[record.sub][year][term];
            }
        }

        if (record.wrongs.length === 0) {
            target.innerHTML = '<p style="text-align:center; padding:40px;">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤!</p>';
            return;
        }

        target.innerHTML = record.wrongs.map(w => {
            const originalQ = sourceQs[w.n - 1];
            if (!originalQ) return `<div class="q-block">ê¸°ì¶œ íšŒì°¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;

            // ë³µìŠµ ì‹œì—ë„ ê³µí†µ ì§€ë¬¸ ì°¾ê¸°
            const commonSource = sourceQs.find(item => 
                item.isCommon && (w.n >= item.comStart && w.n <= item.comEnd)
            );

            return `
                <div class="q-block" style="border-left:5px solid var(--wrong); margin-bottom:25px; padding:20px;">
                    ${commonSource ? `<div class="common-text-box" style="font-size:0.9rem; margin-bottom:15px;">${commonSource.commonText}</div>` : ''}
                    <div style="font-weight:bold; margin-bottom:15px;">${w.n}ë²ˆ. ${originalQ.question}</div>
                    <div style="margin-bottom:15px;">
                        ${originalQ.options.map((opt, oi) => {
                            const num = oi + 1;
                            const isU = String(num) === String(w.user);
                            const isA = String(num) === String(originalQ.answer);
                            let bg = isA ? "#f0fff4" : (isU ? "#fff5f5" : "#fff");
                            let bc = isA ? "var(--correct)" : (isU ? "var(--wrong)" : "#ddd");
                            return `<div style="padding:10px; margin:5px 0; border:1px solid ${bc}; background:${bg}; border-radius:6px;">
                                ${num}) ${opt} ${isA ? '<b>[ì •ë‹µ]</b>' : ''} ${isU && !isA ? '<b>[ë‚´ ì„ íƒ]</b>' : ''}
                            </div>`;
                        }).join('')}
                    </div>
                    <div style="background:#f8f9fa; padding:12px; border-radius:8px; font-size:0.9rem;">
                        <b>ğŸ’¡ í•´ì„¤:</b> ${originalQ.commentary || 'í•´ì„¤ ì—†ìŒ'}
                    </div>
                </div>`;
        }).join('');
    }

    window.openReview = (idx) => {
        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        const data = history[idx];
        if (!data) return;

        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('review-page').classList.remove('hidden');
        document.getElementById('review-title').innerText = `${data.sub} ë³µìŠµ`;
        document.getElementById('review-summary').innerHTML = `
            <span>íšŒì°¨: ${data.title}</span>
            <span>ì ìˆ˜: ${data.score}ì </span>
            <span>ì˜¤ë‹µ: ${data.wrongs.length}</span>
        `;

        renderReviewList('review-detail-list', data);
        document.getElementById('review-page').scrollTop = 0;
    };

    window.closeReview = () => {
        document.getElementById('review-page').classList.add('hidden');
        document.getElementById('setup-page').classList.remove('hidden');
    };

    function renderHistory() {
        const cont = document.getElementById('history-container');
        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        if(!history.length) { cont.innerHTML = '<p style="text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        cont.innerHTML = history.map((h, i) => `
            <div class="history-card" onclick="openReview(${i})" style="cursor:pointer; padding:15px; border:1px solid #ddd; margin-bottom:10px; border-radius:10px;">
                <div style="display:flex; justify-content:space-between;"><b>${h.sub}</b> <span>${h.score}ì </span></div>
                <small>${h.title} | ${h.date}</small>
            </div>`).join('');
    }

    // [ì¶”ê°€] ëª¨ë“  ì‘ì‹œ ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
    window.clearHistory = () => {
        if (confirm("ì €ì¥ëœ ëª¨ë“  ì‘ì‹œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            localStorage.removeItem('knou_history'); // ë°ì´í„° ì‚­ì œ
            renderHistory(); // í™”ë©´ ê°±ì‹ 
            alert("ëª¨ë“  ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };

    init();
</script>
</body>
</html>