<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</title>
    <style>
        :root { --knou-blue: #004a94; --gold: #ffd700; --bg: #f4f7f9; --border: #dee2e6; --wrong: #e74c3c; --correct: #27ae60; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); margin: 0; padding: 0; overflow: hidden; }
        .hidden { display: none !important; }

        /* í™ˆ í™”ë©´ */
        .home-container { max-width: 1000px; margin: 30px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); height: 85vh; overflow-y: auto; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 40px; }
        
        /* ì‹œí—˜ í™”ë©´ */
        .exam-page { display: flex; flex-direction: column; height: 100vh; width: 100vw; background: #fff; }
        .exam-header { background: var(--knou-blue); color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .exam-body { display: flex; flex: 1; overflow: hidden; }
        
        .question-area { flex: 1; overflow-y: auto; padding: 30px 50px; background: white; scroll-behavior: smooth; }
        .omr-area { width: 380px; background: #f8f9fa; border-left: 2px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .omr-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .omr-footer { padding: 15px; background: #fff; border-top: 1px solid var(--border); }

        /* ë¬¸ì œ UI */
        .common-text-box { background-color: #fff9db; border: 2px solid #fab005; border-radius: 8px; padding: 20px; margin-bottom: 25px; line-height: 1.7; white-space: pre-wrap; font-weight: 500; color: #333; }
        .common-tag { display: inline-block; background: #fab005; color: #000; padding: 2px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; margin-bottom: 12px; }
        .q-image-container { margin: 15px 0; text-align: left; background: #fff; }
        .q-image-container img { max-width: 45%; height: auto; border: 1px solid #eee; border-radius: 4px; }
        .q-block { position: relative; padding: 25px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 40px; background: #fff; }
        .idx-btn { width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; background: white; }
        .idx-btn.checked { background: var(--gold); border-color: #e6c200; font-weight: bold; }
        .idx-btn.checked::after { content: 'âœ“'; color: #333; }
        .opt-item { padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; margin: 8px 0; cursor: pointer; transition: 0.2s; }
        .opt-item.selected { background: #e7f1ff; border-color: var(--knou-blue); font-weight: bold; }
        
        /* OMR í…Œì´ë¸” */
        .omr-table { width: 100%; border-collapse: collapse; background: white; }
        .omr-table tr { border-bottom: 1px solid #eee; height: 45px; }
        .omr-num-cell { width: 40px; font-weight: bold; text-align: center; color: var(--knou-blue); cursor: pointer; }
        .omr-circle { width: 28px; height: 28px; border: 1px solid #777; border-radius: 50%; display: inline-block; text-align: center; line-height: 28px; cursor: pointer; font-size: 0.85rem; margin: 0 2px; }
        .omr-circle.marked { background: #333; color: white; border-color: #333; }

        .btn { padding: 10px 18px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-blue { background: var(--knou-blue); color: white; }
        .btn-dark { background: #333; color: white; }
        
        .history-card { background: #fdfdfd; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .nav-footer { position: sticky; bottom: 0; background: white; border-top: 1px solid #eee; padding: 15px; display: flex; justify-content: center; gap: 30px; align-items: center; }
        .top-btn { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: var(--knou-blue); color: white; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; display: none; }

        .correct-highlight { background-color: #e6fcf5 !important; border: 2px solid var(--correct) !important; color: var(--correct); font-weight: bold; }
        .wrong-highlight { background-color: #fff5f5 !important; border: 2px solid var(--wrong) !important; }

        /* í‘¸í„° ìŠ¤íƒ€ì¼ */
        .site-footer {
            margin-top: 40px; padding: 20px 0; border-top: 1px solid var(--border);
            text-align: center; color: #666; font-size: 0.85rem; line-height: 1.6;
        }
        .site-footer a { color: var(--knou-blue); text-decoration: none; font-weight: bold; }

        .context-box {
            border: 2px solid #333; /* ê²€ì •ìƒ‰ í…Œë‘ë¦¬ */
            padding: 15px;          /* ì•ˆìª½ ì—¬ë°± */
            margin: 10px 0;         /* ë°•ìŠ¤ ìœ„ì•„ë˜ ê°„ê²© */
            background-color: #f9f9f9; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
            white-space: pre-wrap;  /* ê³µë°±ê³¼ ì¤„ë°”ê¿ˆ ìœ ì§€ (ê°€ì¥ ì¤‘ìš”!) */
            line-height: 1.6;       /* ì¤„ ê°„ê²© */
        }
        .example-box {
            border: 1px solid #777;
            padding: 10px;
            margin: 10px 20px;     /* ì¢Œìš° ì—¬ë°±ì„ ì£¼ì–´ ì•ˆìœ¼ë¡œ ë“¤ì—¬ì“°ê¸° */
            font-size: 0.9em;      /* ë¬¸ì œë³´ë‹¤ ì•½ê°„ ì‘ì€ ê¸€ì”¨ */
            white-space: pre-wrap;
        }                       
    </style>
</head>
<body>

<div id="setup-page" class="home-container">
    <h1 style="text-align:center; color:var(--knou-blue); margin-bottom: 30px;">KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</h1>
    <div class="grid-layout">
        <div>
            <h3>ğŸ›  ì‹œí—˜ ì„¤ì •</h3>
            <label><b>ê³¼ëª© ì„ íƒ</b></label>
            <select id="sel-subject" style="width:100%; padding:12px; margin:10px 0; border-radius:5px; border:1px solid #ccc;">
                <option value="">ë°ì´í„° ë¡œë”© ì¤‘...</option>
            </select>
            <label><b>ì‹œí—˜ íšŒì°¨</b></label>
            <div id="exam-radio-container" style="margin-top:8px; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; background:#fafafa; border-radius:5px;">ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
            <div id="random-options" class="hidden" style="margin:15px 0; background:#eef2f7; padding:15px; border-radius:8px;">
                <label><b>ì¶”ì¶œ ë¬¸í•­ ìˆ˜</b></label>
                <div style="margin-top:8px; display:flex; gap:10px;">
                    <label><input type="radio" name="rd-cnt" value="15"> 15</label>
                    <label><input type="radio" name="rd-cnt" value="25" checked> 25</label>
                    <label><input type="radio" name="rd-cnt" value="40"> 40</label>
                    <label><input type="radio" name="rd-cnt" value="50"> 50</label>
                </div>
            </div>
            <label><b>ì‘ì‹œ ë°©ì‹</b></label>
            <select id="sel-study-mode" style="width:100%; padding:12px; margin:10px 0; border-radius:5px;">
                <option value="normal-all">ì¼ë°˜: ì „ì²´ ë¬¸ì œ í•œë²ˆì— ë³´ê¸° (OMR)</option>
                <option value="normal-step">ì¼ë°˜: 1ë¬¸ì œì”© ë³´ê¸° (OMR)</option>
                <option value="study">ì—°ìŠµ: í•´ì„¤ ë³´ë©° í’€ê¸° (1ë¬¸ì œì”©)</option>
            </select>
            <div style="margin-bottom:20px; background:#fff3e0; padding:12px; border-radius:8px;">
                <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="extra-time-chk"> <b>ì‹œí—˜ ì‹œê°„ ì—°ì¥ (íŠ¹ë³„ê´€ë¦¬ëŒ€ìƒ)</b>
                </label>
            </div>
            <button class="btn btn-blue" style="width:100%; height:55px;" onclick="prepareExam()">ì‹œí—˜ ì‹œì‘</button>
        </div>
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">ğŸ“œ ìµœê·¼ í’€ì´ ê¸°ë¡</h3>
                <button class="btn" style="background: #e74c3c; color: white; padding: 5px 10px; font-size: 0.8rem;" onclick="clearHistory()">ê¸°ë¡ ì´ˆê¸°í™”</button>
            </div>
            <div id="history-container"></div>
        </div>
    </div>
    <footer class="site-footer">
        <p>ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë° ë¬¸ì œ ì‹ ê³ : <a href="mailto:minjukang727@gmail.com">minjukang727@gmail.com</a></p>
        <p>Â© 2026 KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</p>
    </footer>
</div>

<div id="exam-page" class="exam-page hidden">
    <div class="exam-header">
        <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="exitToHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
        <div id="exam-title" style="font-weight:bold;"></div>
        <div id="timer-display" style="font-size:1.4rem; color:var(--gold); font-weight:bold;">00:00</div>
    </div>
    <div class="exam-body">
        <div class="question-area" id="q-container"></div>
        <div class="omr-area" id="omr-panel">
            <div class="omr-scroll">
                <h4 style="text-align:center; margin-top:0;">OMR ë‹µì•ˆì§€</h4>
                <table class="omr-table">
                    <tbody id="omr-rows-target"></tbody>
                </table>
                <div style="text-align:center; padding:20px; color:#999; font-size:0.75rem; border-top:1px dashed #ccc; margin-top:20px;">
                    ë¬¸ì˜: minjukang727@gmail.com
                </div>
            </div>
            <div class="omr-footer"><button class="btn btn-dark" style="width:100%;" onclick="confirmSubmit()">ìµœì¢… ì œì¶œ</button></div>
        </div>
    </div>
    <div id="step-nav" class="nav-footer hidden">
        <button class="btn btn-dark" onclick="moveIdx(-1)">ì´ì „</button>
        <div id="step-count" style="font-weight:bold;"></div>
        <button class="btn btn-dark" onclick="moveIdx(1)">ë‹¤ìŒ</button>
    </div>
</div>

<div id="result-page" class="hidden" style="overflow-y:auto; height:100vh; background:#fff; padding:40px;">
    <div style="max-width:850px; margin:0 auto;">
        <div style="display: flex; justify-content: flex-start; margin-bottom: 20px;">
            <button class="btn btn-dark" onclick="location.reload()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <h1 style="text-align:center; color:var(--knou-blue);">ì‹œí—˜ ê²°ê³¼</h1>
        <div id="result-summary" style="background:#f8f9fa; padding:25px; border-radius:12px; margin-bottom:30px; display:grid; grid-template-columns:1fr 1fr; gap:15px; border:1px solid #eee;"></div>
        <h3 style="color:var(--wrong);">âŒ ì˜¤ë‹µ ë° ì •ë‹µ í™•ì¸</h3>
        <div id="wrong-detail-list"></div>
        <button class="btn btn-blue" style="width:100%; margin-top:30px; height: 50px;" onclick="location.reload()">í™ˆìœ¼ë¡œ</button>
        <footer class="site-footer">
            <p>ë°ì´í„° ì˜¤ë¥˜ ì œë³´: <a href="mailto:minjukang727@gmail.com">minjukang727@gmail.com</a></p>
            <p>Â© 2026 KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</p>
        </footer>
    </div>
</div>

<div id="review-page" class="hidden" style="overflow-y:auto; height:100vh; background:#fff; padding:40px;">
    <div style="max-width:850px; margin:0 auto;">
        <button class="btn btn-dark" onclick="closeReview()">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <h1 id="review-title" style="text-align:center; color:var(--knou-blue); margin-top:20px;"></h1>
        <div id="review-summary" style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:30px; border:1px solid #eee; display:flex; justify-content:space-around; font-weight:bold;"></div>
        <h3 style="color:var(--wrong); border-bottom:2px solid var(--wrong); padding-bottom:10px;">âŒ ë‹¤ì‹œ ë³´ê¸° (ì˜¤ë‹µ ë° ì „ì²´ ë³´ê¸°)</h3>
        <div id="review-detail-list"></div>
        <button class="btn btn-blue" style="width:100%; margin-top:30px;" onclick="closeReview()">í™•ì¸ ì™„ë£Œ</button>
        <footer class="site-footer">
            <p>ë¬¸ì œ ì˜¤ë¥˜ ë¬¸ì˜: <a href="mailto:minjukang727@gmail.com">minjukang727@gmail.com</a></p>
            <p>Â© 2026 KNOU ìŠ¤ë§ˆíŠ¸ ë¬¸ì œ ì€í–‰</p>
        </footer>
    </div>
</div>

<button id="btn-top" class="top-btn" onclick="scrollToTop()">TOP</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://qbank-f4821-default-rtdb.asia-southeast1.firebasedatabase.app" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let quizData = {}, currentQs = [], userAnswers = {}, indexMarks = {}, currentIdx = 0;
    let examInfo = { sub: "", title: "", mode: "" };
    let timeLeft = 0, initialTime = 0, timerInterval = null;

    function getSafeImageUrl(data) {
        if (!data || (typeof data === 'string' && data.trim() === "")) return null;
        let src = data.toString().trim();
        if (!src.startsWith('data:') && !src.startsWith('http')) {
            src = `data:image/png;base64,${src}`;
        }
        return src;
    }

    window.scrollToTop = () => {
        window.scrollTo({top: 0, behavior: 'smooth'});
        document.querySelector('.question-area').scrollTop = 0;
        document.getElementById('result-page').scrollTop = 0;
        document.getElementById('review-page').scrollTop = 0;
    };

    function handleGlobalScroll() {
        const btn = document.getElementById('btn-top');
        const examScroll = document.querySelector('.question-area').scrollTop;
        const resultScroll = document.getElementById('result-page').scrollTop;
        const reviewScroll = document.getElementById('review-page').scrollTop;
        const winScroll = window.scrollY || document.documentElement.scrollTop;
        if (winScroll > 200 || examScroll > 200 || resultScroll > 200 || reviewScroll > 200) { btn.style.display = "block"; } else { btn.style.display = "none"; }
    }

    window.addEventListener('scroll', handleGlobalScroll);
    document.addEventListener('scroll', handleGlobalScroll, true); 

    async function init() {
        renderHistory();
        const subSel = document.getElementById('sel-subject');
        try {
            const snapshot = await get(ref(db, 'quizzes'));
            if (snapshot.exists()) { quizData = snapshot.val(); updateSubjectList(); } 
            else { subSel.innerHTML = '<option>ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</option>'; }
        } catch (error) { subSel.innerHTML = '<option>ì—°ê²° ì˜¤ë¥˜</option>'; }
        
        onValue(ref(db, 'quizzes'), (snap) => { if(snap.exists()) { quizData = snap.val(); updateSubjectList(); } });
    }

    function updateSubjectList() {
        const subSel = document.getElementById('sel-subject');
        const subjects = Object.keys(quizData); 
        if (subjects.length > 0) {
            subSel.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>';
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                subSel.appendChild(opt);
            });
        }
    }

    document.getElementById('sel-subject').onchange = (e) => {
        const sub = e.target.value;
        const cont = document.getElementById('exam-radio-container');
        if(!sub || !quizData[sub]) { cont.innerHTML = "íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
        cont.innerHTML = `<label style="display:block; margin:5px 0;"><input type="radio" name="exam-sel" value="random" onchange="toggleRandom(true)"> ğŸ² ì „ì²´ ëœë¤ ê¸°ì¶œ</label>`;
        const years = Object.keys(quizData[sub]);
        years.forEach(y => {
            const types = Object.keys(quizData[sub][y]);
            types.forEach(t => {
                cont.innerHTML += `<label style="display:block; margin:5px 0; cursor:pointer;"><input type="radio" name="exam-sel" value="${y}|${t}" onchange="toggleRandom(false)"> ${y} ${t}ì‹œí—˜</label>`;
            });
        });
    };

    window.toggleRandom = (isRand) => document.getElementById('random-options').classList.toggle('hidden', !isRand);
    window.exitToHome = () => { if(confirm("ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); };

    window.prepareExam = () => {
        const sub = document.getElementById('sel-subject').value;
        const sel = document.querySelector('input[name="exam-sel"]:checked');
        if(!sub || !sel) return alert("ê³¼ëª©ê³¼ íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

        examInfo.sub = sub;
        examInfo.mode = document.getElementById('sel-study-mode').value;
        userAnswers = {}; indexMarks = {}; currentIdx = 0;

        if(sel.value === 'random') {
            const cnt = parseInt(document.querySelector('input[name="rd-cnt"]:checked').value);
            let pool = [];
            Object.values(quizData[sub]).forEach(y => Object.values(y).forEach(l => pool = pool.concat(l)));
            currentQs = pool.sort(() => Math.random() - 0.5).slice(0, cnt);
            examInfo.title = `ëœë¤ ${cnt}ë¬¸í•­`;
        } else {
            const [y, t] = sel.value.split('|');
            currentQs = quizData[sub][y][t];
            examInfo.title = `${y}ë…„ ${t}`;
        }

        const isExtra = document.getElementById('extra-time-chk').checked;
        let base = (currentQs.length <= 15) ? 15 : (currentQs.length <= 25) ? 25 : 50;
        initialTime = (base + (isExtra ? 10 : 0)) * 60;
        timeLeft = initialTime;

        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('exam-page').classList.remove('hidden');
        document.getElementById('exam-title').innerText = `[${sub}] ${examInfo.title}`;
        document.getElementById('omr-panel').classList.toggle('hidden', examInfo.mode === 'study');
        document.getElementById('step-nav').classList.toggle('hidden', examInfo.mode === 'normal-all');

        startTimer();
        renderExam();
    };

    const DUP_ANSWER_MAP = { "A": [1, 2], "B": [1, 3], "C": [1, 4], "D": [2, 3], "E": [2, 4], "F": [3, 4], "G": [1, 2, 3], "H": [1, 2, 4], "I": [1, 3, 4], "J": [2, 3, 4], "K": [1, 2, 3, 4] };

    function toCircleNum(n) {
        const circleNums = { 1: "â‘ ", 2: "â‘¡", 3: "â‘¢", 4: "â‘£", 5: "â‘¤" };
        const val = String(n).toUpperCase();
        if (DUP_ANSWER_MAP[val]) return DUP_ANSWER_MAP[val].map(num => circleNums[num] || num).join(", ");
        return circleNums[val] || val;
    }

    function checkIsCorrect(userAns, quizAns) {
        if (!userAns) return false;
        const correctVal = String(quizAns).toUpperCase();
        const userVal = Number(userAns);
        if (DUP_ANSWER_MAP[correctVal]) return DUP_ANSWER_MAP[correctVal].includes(userVal);
        return String(userVal) === correctVal;
    }

    window.renderExam = () => {
        const qCont = document.getElementById('q-container');
        qCont.innerHTML = '';
        const list = (examInfo.mode === 'normal-all') ? currentQs : [currentQs[currentIdx]];
        
        list.forEach((q, i) => {
            const num = (examInfo.mode === 'normal-all') ? i + 1 : currentIdx + 1;
            const block = document.createElement('div');
            block.className = 'q-block';
            block.id = `q-row-${num}`;

            const commonSource = currentQs.find(item => item.isCommon && (num >= item.comStart && num <= item.comEnd));
            let commonHtml = '';
            if (commonSource && (examInfo.mode !== 'normal-all' || num === commonSource.comStart)) {
                commonHtml = `<div class="common-text-box"><div class="common-tag">ì§€ë¬¸ ì°¸ì¡° (${commonSource.comStart}~${commonSource.comEnd})</div><div>${commonSource.commonText}</div></div>`;
            }

            const imgSrc = getSafeImageUrl(q.image_data || q.image_url || q.img || q.image); 
            const imageHtml = imgSrc ? `<div class="q-image-container"><img src="${imgSrc}" onerror="this.parentElement.style.display='none'"></div>` : '';

            block.innerHTML = `
                ${commonHtml}
                <div style="position:absolute; top:15px; left:15px;">
                    <div class="idx-btn ${indexMarks[num]?'checked':''}" onclick="toggleIdx(${num})"></div>
                </div>
                <div style="margin-left:35px;">
                    <div style="font-weight:bold; margin-bottom:15px;">${num}. ${q.question}</div>
                    ${imageHtml}
                    ${q.options.map((opt, oi) => `
                        <div class="opt-item ${userAnswers[num]==oi+1?'selected':''}" onclick="mark(${num}, ${oi+1})">
                            ${oi+1}) ${opt}
                        </div>
                    `).join('')}
                    <div id="study-res-${num}"></div>
                    ${examInfo.mode==='study' ? `<button class="btn btn-blue" style="width:100%; margin-top:15px;" onclick="checkStudy(${num}, ${q.answer}, '${(q.commentary||'').replace(/'/g, "\\'")}')">ì •ë‹µ í™•ì¸</button>` : ''}
                </div>`;
            qCont.appendChild(block);
        });

        if(examInfo.mode !== 'study') renderOMR();
        if(examInfo.mode !== 'normal-all') document.getElementById('step-count').innerText = `${currentIdx+1} / ${currentQs.length}`;
    };

    window.renderOMR = () => {
        const target = document.getElementById('omr-rows-target');
        if (!target) return;
        target.innerHTML = '';
        currentQs.forEach((q, i) => {
            const n = i + 1;
            const optionCount = q.options ? q.options.length : 4;
            const optionArray = Array.from({ length: optionCount }, (_, idx) => idx + 1);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="omr-num-cell" onclick="handleOmrNumClick(${n})">${n}</td>
                <td style="text-align:center;">
                    ${optionArray.map(v => `<div class="omr-circle ${userAnswers[n] == v ? 'marked' : ''}" onclick="mark(${n}, ${v})">${v}</div>`).join('')}
                </td>
                <td style="text-align:center;"><div class="idx-btn ${indexMarks[n] ? 'checked' : ''}" onclick="toggleIdx(${n})"></div></td>`;
            target.appendChild(tr);
        });
    };

    window.handleOmrNumClick = (n) => { scrollToQ(n); toggleIdx(n); };
    window.mark = (n, v) => { userAnswers[n] = String(v); renderExam(); renderOMR(); };
    window.toggleIdx = (n) => { indexMarks[n] = !indexMarks[n]; renderExam(); renderOMR(); };
    window.scrollToQ = (n) => { if(examInfo.mode === 'normal-all') { document.getElementById(`q-row-${n}`).scrollIntoView({ behavior: 'smooth' }); } else { currentIdx = n - 1; renderExam(); } };
    window.moveIdx = (dir) => { const next = currentIdx + dir; if(next >= 0 && next < currentQs.length) { currentIdx = next; renderExam(); } };

    window.checkStudy = (n, ans, comm) => {
        if(!userAnswers[n]) return alert("ë‹µì•ˆì„ ì„ íƒí•˜ì„¸ìš”.");
        const isR = checkIsCorrect(userAnswers[n], ans);
        document.getElementById(`study-res-${n}`).innerHTML = `
            <div style="padding:15px; margin-top:15px; background:#f8f9fa; border-left:4px solid ${isR? 'var(--correct)':'var(--wrong)'}; border-radius:5px;">
                <b style="color:${isR?'var(--correct)':'var(--wrong)'}">${isR ? 'â­• ì •ë‹µ' : 'âŒ ì˜¤ë‹µ'} (ì •ë‹µ: ${toCircleNum(ans)})</b><br>
                <div style="margin-top:5px; font-size:0.95rem; color:#555;">${comm}</div>
            </div>`;
    };

    function startTimer() { timerInterval = setInterval(() => { timeLeft--; const m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(timeLeft <= 0) { clearInterval(timerInterval); showResults(); } }, 1000); }
    window.confirmSubmit = () => { if(confirm("ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { clearInterval(timerInterval); showResults(); } };

    function showResults() {
        let correctCount = 0, earnedScore = 0, totalPossibleScore = 0, wrongIndices = [];
        const hasScoreData = currentQs.some(q => q.score && q.score > 0);
        currentQs.forEach((q, i) => {
            const n = i + 1;
            const uAns = userAnswers[n];
            const isCorrect = checkIsCorrect(uAns, q.answer);
            if (hasScoreData) {
                const point = parseFloat(q.score || 0);
                totalPossibleScore += point;
                if (isCorrect) { correctCount++; earnedScore += point; }
            } else { if (isCorrect) correctCount++; }
            if (!isCorrect) wrongIndices.push({ n: n, user: uAns || "ë¯¸í‘œê¸°" });
        });
        let finalScore = hasScoreData ? Math.round(earnedScore * 10) / 10 : Math.round((correctCount / currentQs.length) * 100);
        let displayTotal = hasScoreData ? Math.round(totalPossibleScore * 10) / 10 : 100;
        const record = { date: new Date().toLocaleString(), sub: examInfo.sub, title: examInfo.title, score: finalScore, totalPossible: displayTotal, wrongs: wrongIndices, isRandom: examInfo.title.includes("ëœë¤"), allQs: currentQs };
        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        history.unshift(record);
        localStorage.setItem('knou_history', JSON.stringify(history.slice(0, 15)));
        document.getElementById('exam-page').classList.add('hidden');
        document.getElementById('result-page').classList.remove('hidden');
        const summaryCont = document.getElementById('result-summary');
        summaryCont.innerHTML = `<div style="text-align:center; grid-column: 1 / span 2; margin-bottom:10px;"><span style="font-size:2.5rem; color:var(--knou-blue); font-weight:bold;">${finalScore}</span> <span style="font-size:1.2rem; color:#666;"> / ${displayTotal} ì </span></div><div style="text-align:center; border-right:1px solid #eee;"><div style="color:#666; font-size:0.9rem;">ë§íŒ ë¬¸í•­</div><div style="font-size:1.2rem; font-weight:bold;">${correctCount} / ${currentQs.length}</div></div><div style="text-align:center;"><div style="color:#666; font-size:0.9rem;">ì •ë‹µë¥ </div><div style="font-size:1.2rem; font-weight:bold;">${Math.round((correctCount/currentQs.length)*100)}%</div></div>`;
        renderReviewList('wrong-detail-list', record); renderHistory();
    }

    window.renderReviewList = (targetId, record) => {
        const target = document.getElementById(targetId);
        let sourceQs = record.allQs || currentQs;
        if (record.wrongs.length === 0) { target.innerHTML = '<p style="text-align:center; padding:40px;">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤!</p>'; return; }
        target.innerHTML = record.wrongs.map(w => {
            const q = sourceQs[w.n - 1];
            if (!q) return '';
            const commonSource = sourceQs.find(item => item.isCommon && (w.n >= item.comStart && w.n <= item.comEnd));
            const imgSrc = getSafeImageUrl(q.image_data || q.image_url || q.img || q.image);
            const imageHtml = imgSrc ? `<div class="q-image-container"><img src="${imgSrc}" onerror="this.parentElement.style.display='none'"></div>` : '';
            return `<div class="q-block" style="border-left:5px solid var(--wrong); padding:20px;">${commonSource ? `<div class="common-text-box" style="font-size:0.9rem;">${commonSource.commonText}</div>` : ''}<div style="font-weight:bold; margin-bottom:15px;">${w.n}ë²ˆ. ${q.question}</div>${imageHtml}<div>${q.options.map((opt, oi) => { const num = oi + 1; const isU = String(num) === String(w.user); const isA = checkIsCorrect(num, q.answer); let cls = 'opt-item'; if (isA) cls += ' correct-highlight'; else if (isU) cls += ' wrong-highlight'; return `<div class="${cls}" style="cursor:default;">${num}) ${opt} ${isA?'<b>[ì •ë‹µ]</b>':''} ${isU && !isA?'<b>[ë‚´ ì„ íƒ]</b>':''}</div>`; }).join('')}</div><div style="background:#f8f9fa; padding:12px; border-radius:8px; font-size:0.9rem; margin-top:10px;"><b>ğŸ’¡ í•´ì„¤:</b> ${q.commentary || 'í•´ì„¤ ì—†ìŒ'}</div></div>`;
        }).join('');
    };

    window.openReview = (idx) => {
        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        const data = history[idx];
        if (!data) return;
        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('review-page').classList.remove('hidden');
        document.getElementById('review-title').innerText = `${data.sub} ë³µìŠµ`;
        document.getElementById('review-summary').innerHTML = `<span>íšŒì°¨: ${data.title}</span><span>ì ìˆ˜: ${data.score}ì </span><span>ì˜¤ë‹µ: ${data.wrongs.length}</span>`;
        renderReviewList('review-detail-list', data);
        document.getElementById('review-page').scrollTop = 0;
    };

    window.closeReview = () => { document.getElementById('review-page').classList.add('hidden'); document.getElementById('setup-page').classList.remove('hidden'); };

    function renderHistory() {
        const cont = document.getElementById('history-container');
        const history = JSON.parse(localStorage.getItem('knou_history') || '[]');
        if(!history.length) { cont.innerHTML = '<p style="text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        cont.innerHTML = history.map((h, i) => `<div class="history-card" onclick="openReview(${i})" style="cursor:pointer;"><div style="display:flex; justify-content:space-between;"><b>${h.sub}</b> <span>${h.score}ì </span></div><small>${h.title} | ${h.date}</small></div>`).join('');
    }

    window.clearHistory = () => { if (confirm("ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem('knou_history'); renderHistory(); } };

    init();
</script>
</body>
</html>