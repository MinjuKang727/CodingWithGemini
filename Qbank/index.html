<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°©ì†¡ëŒ€ ê¸°ì¶œ ë§ˆìŠ¤í„° v4.1</title>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCNnZltTeWoOodD7zmonx34RivTz6i8s04",
        authDomain: "qbank-f4821.firebaseapp.js", // .firebaseapp.comì—ì„œ .jsë¡œ ì˜¤íƒ€ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‹ˆ í™•ì¸ í•„ìˆ˜
        databaseURL: "https://qbank-f4821-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "qbank-f4821",
        storageBucket: "qbank-f4821.appspot.com",
        messagingSenderId: "150452150398",
        appId: "1:150452150398:web:a65a9ddfb8250c2895782f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // ë¡œê·¸ì¸ í•¨ìˆ˜ë¥¼ window ê°ì²´ì— ì§ì ‘ í• ë‹¹
    window.handleLogin = async () => {
        try {
            if (window.user) {
                await auth.signOut();
                alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } else {
                const result = await signInWithPopup(auth, provider);
                console.log("ë¡œê·¸ì¸ ì„±ê³µ:", result.user);
            }
        } catch (error) {
            console.error("ë¡œê·¸ì¸ ì—ëŸ¬ ìƒì„¸:", error);
            // ì—ëŸ¬ ë©”ì‹œì§€ì— ë”°ë¼ ì›ì¸ íŒŒì•… ê°€ëŠ¥
            if (error.code === 'auth/operation-not-allowed') {
                alert("ì—ëŸ¬: Firebase ì½˜ì†”ì—ì„œ Google ë¡œê·¸ì¸ì„ 'ì‚¬ìš© ì„¤ì •'í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            } else if (error.code === 'auth/unauthorized-domain') {
                alert("ì—ëŸ¬: í˜„ì¬ ë„ë©”ì¸ì´ Firebase ìŠ¹ì¸ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.");
            } else {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            }
        }
    };

    onAuthStateChanged(auth, (u) => {
        window.user = u;
        document.getElementById('loginBtn').innerText = u ? "ë¡œê·¸ì•„ì›ƒ" : "ë¡œê·¸ì¸";
        document.getElementById('userInfo').innerText = u ? `ë°˜ê°‘ìŠµë‹ˆë‹¤, ${u.displayName}ë‹˜` : "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        // ê´€ë¦¬ì í™•ì¸
        if(u?.email === "minjukang727@gmail.com") {
            document.body.classList.add('admin-authorized');
        }
    });
</script>
    <style>
        :root { --primary: #4285F4; --bg: #f0f2f5; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .quiz-card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .category-tag { color: var(--primary); font-size: 0.85em; font-weight: bold; margin-bottom: 10px; display: block; }
        .question { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; white-space: pre-wrap; }
        .option { padding: 12px; margin: 8px 0; background: #f8f9fa; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .option:hover { background: #eef2ff; border-color: #cbd5e1; }
        .option.correct { background: #e8f8f0; border-color: #2ecc71; color: #1e7e34; }
        .option.wrong { background: #fdf2f2; border-color: #e74c3c; color: #b91c1c; }
        .admin-controls { display: none; margin-top: 15px; background: #fff5f5; padding: 10px; border-radius: 8px; }
        .admin-authorized .admin-controls { display: block; }
        button { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd; background: white; }
        .btn-wrong { background: #ff9800; color: white; border: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ“š ë°©ì†¡ëŒ€ ë§ˆìŠ¤í„°</h2>
        <div>
            <span id="userInfo"></span>
            <button id="loginBtn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="btn-wrong" onclick="toggleWrongOnly()">ì˜¤ë‹µë…¸íŠ¸</button>
        </div>
    </div>
    <div id="quizDisplay">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script>
    let rawData = {};
    let flattenedQuizzes = [];
    let showWrongOnly = false;

    // 1. ì¤‘ì²©ëœ JSONì„ í’€ì–´ì„œ(Flatten) ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
    function flattenData(data) {
        let list = [];
        for (let subject in data) {
            for (let year in data[subject]) {
                for (let exam in data[subject][year]) {
                    data[subject][year][exam].forEach((q, idx) => {
                        list.push({
                            ...q,
                            dbPath: `${subject}/${year}/${exam}/${idx}`, // DB ì—…ë°ì´íŠ¸ìš© ê²½ë¡œ
                            category: `${subject} > ${year} > ${exam}`
                        });
                    });
                }
            }
        }
        return list;
    }

    async function fetchQuizData() {
        const snapshot = await window.get(window.ref(window.db, '/'));
        if (snapshot.exists()) {
            rawData = snapshot.val();
            flattenedQuizzes = flattenData(rawData);
            renderQuizzes();
        }
    }

    function renderQuizzes() {
        const display = document.getElementById('quizDisplay');
        let targetData = flattenedQuizzes;

        // ì˜¤ë‹µë…¸íŠ¸ ëª¨ë“œì¼ ë•Œ í•„í„°ë§ (êµ¬í˜„ í•„ìš” ì‹œ ì¶”ê°€ ë¡œì§)
        if (showWrongOnly) {
            // ì—¬ê¸°ì— window.userì˜ ì˜¤ë‹µ ëª©ë¡ê³¼ ë¹„êµí•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        }

        display.innerHTML = targetData.map((q, index) => `
            <div class="quiz-card">
                <span class="category-tag">${q.category}</span>
                <div class="question">${q.question}</div>
                <div class="options" data-correct="${q.answer}">
                    ${q.options.map((opt, i) => `
                        <div class="option" onclick="checkAnswer(this, ${i+1}, ${q.answer}, '${q.id}')">
                            ${i+1}. ${opt}
                        </div>
                    `).join('')}
                </div>
                <div class="admin-controls">
                    <button onclick="setAnswer('${q.dbPath}')">ì •ë‹µ ì„¤ì •</button>
                    <button onclick="editQuestion('${q.dbPath}', \`${q.question}\`)">ë¬¸ì œ ìˆ˜ì •</button>
                    <small style="color:red">í˜„ì¬ ì •ë‹µ: ${q.answer || 'ë¯¸ì„¤ì •'}</small>
                </div>
            </div>
        `).join('');
    }

    function checkAnswer(el, picked, correct, qId) {
        if (!correct) return alert("ê´€ë¦¬ìê°€ ì•„ì§ ì •ë‹µì„ ì„¤ì •í•˜ì§€ ì•Šì€ ë¬¸ì œì…ë‹ˆë‹¤.");
        const card = el.parentElement;
        if (card.classList.contains('done')) return;

        if (picked === correct) {
            el.classList.add('correct');
        } else {
            el.classList.add('wrong');
            card.children[correct-1].classList.add('correct');
            saveWrongAnswer(qId);
        }
        card.classList.add('done');
    }

    async function saveWrongAnswer(qId) {
        if (!window.user) return;
        await window.set(window.ref(window.db, `users/${window.user.uid}/wrong/${qId}`), true);
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥: ì •ë‹µ ì„¤ì •
    async function setAnswer(path) {
        const ans = prompt("ì •ë‹µ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1~4):");
        if (ans) {
            await window.update(window.ref(window.db, path), { answer: parseInt(ans) });
            fetchQuizData();
        }
    }

    async function handleLogin() {
        if (window.user) { await window.auth.signOut(); location.reload(); }
        else { await window.signInWithPopup(window.auth, new window.GoogleAuthProvider()); }
    }
</script>
</body>
</html>