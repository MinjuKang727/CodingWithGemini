<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QBank - ê¸°ì¶œ ë¬¸ì œ ì€í–‰</title>
    <style>
        body { font-family: 'ë§‘ì€ ê³ ë”•', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .subject-title { color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        .quiz-btn { background: #fff; border: 1px solid #dadce0; padding: 10px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .quiz-btn:hover { background: #e8f0fe; color: #1967d2; }
        #userInfo { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 10px; }
        /* ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê³ ì • */
        #authBtn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: background 0.3s; }
        .btn-login { background: #1a73e8; }
        .btn-logout { background: #5f6368; }
        #quiz-screen { display: none; }
        .option-btn { display: block; width: 100%; text-align: left; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="userInfo">
        <span id="userText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        <button id="authBtn" class="btn-login">ë¡œê·¸ì¸</button>
    </div>

    <div id="main-screen">
        <h1>ğŸ“š ë‚˜ì˜ ë¬¸ì œ ì€í–‰</h1>
        <div id="quiz-list">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div id="quiz-screen" class="card">
        <button onclick="showMain()">â¬… ëª©ë¡ìœ¼ë¡œ</button>
        <h3 id="quiz-info"></h3>
        <div id="question-container">
            <p id="q-text" style="font-size: 1.1rem; font-weight: bold;"></p>
            <div id="options-container"></div>
        </div>
        <div style="margin-top:20px; display:flex; justify-content: space-between; align-items: center;">
            <button onclick="prevQuestion()">ì´ì „</button>
            <span id="page-num"></span>
            <button onclick="nextQuestion()">ë‹¤ìŒ</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCNnZltTeWoOodD7zmonx34RivTz6i8s04",
        authDomain: "qbank-f4821.firebaseapp.com",
        databaseURL: "https://qbank-f4821-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "qbank-f4821"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    let allData = {};
    let currentQuizSet = [];
    let currentIdx = 0;

    const authBtn = document.getElementById('authBtn');
    const userText = document.getElementById('userText');

    // [UI ì—…ë°ì´íŠ¸ í•µì‹¬ í•¨ìˆ˜]
    function updateAuthUI(user) {
        if (user) {
            userText.innerText = `${user.displayName}ë‹˜ `;
            authBtn.innerText = "ë¡œê·¸ì•„ì›ƒ";
            authBtn.className = "btn-logout";
            authBtn.onclick = () => {
                signOut(auth).then(() => {
                    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.reload();
                });
            };
        } else {
            userText.innerText = "ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ";
            authBtn.innerText = "ë¡œê·¸ì¸";
            authBtn.className = "btn-login";
            authBtn.onclick = () => {
                signInWithRedirect(auth, provider);
            };
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²°ê³¼ ì²˜ë¦¬ ë° UI ë™ê¸°í™”
    getRedirectResult(auth)
        .then((result) => {
            if (result && result.user) {
                console.log("ë¡œê·¸ì¸ ì„±ê³µ!", result.user.displayName);
                updateAuthUI(result.user);
            } else if (auth.currentUser) {
                console.log("ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:", auth.currentUser.displayName);
                updateAuthUI(auth.currentUser);
            }
        })
        .catch((error) => {
            console.error("ì¸ì¦ ì—ëŸ¬ ìƒì„¸:", error.code, error.message);
            // ì—¬ê¸°ì„œ auth/unauthorized-domain ì—ëŸ¬ê°€ ëœ¨ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤!
            if (error.code === 'auth/unauthorized-domain') {
                alert("Firebase ì½˜ì†”ì— ë„ë©”ì¸ì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤: " + window.location.hostname);
            }
        });

    // ì¸ì¦ ìƒíƒœ ì‹¤ì‹œê°„ ê°ì‹œ
    onAuthStateChanged(auth, (user) => {
        updateAuthUI(user);
    });

    // ë°ì´í„° ë¡œë“œ
    onValue(ref(db, '/'), (snapshot) => {
        allData = snapshot.val();
        renderList();
    });

    function renderList() {
        const listDiv = document.getElementById('quiz-list');
        if (!allData) return;
        let html = "";
        for (let subject in allData) {
            if (typeof allData[subject] !== 'object') continue;
            html += `<div class="card"><h2 class="subject-title">ğŸ“˜ ${subject}</h2>`;
            for (let year in allData[subject]) {
                for (let type in allData[subject][year]) {
                    html += `<button class="quiz-btn" onclick="startQuiz('${subject}', '${year}', '${type}')">
                                ${year}ë…„ ${type}
                             </button>`;
                }
            }
            html += `</div>`;
        }
        listDiv.innerHTML = html;
    }

    window.startQuiz = (s, y, t) => {
        if (!auth.currentUser) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
            return;
        }
        currentQuizSet = allData[s][y][t];
        currentIdx = 0;
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        document.getElementById('quiz-info').innerText = `${s} (${y}ë…„ ${t})`;
        displayQuestion();
    };

    function displayQuestion() {
        const q = currentQuizSet[currentIdx];
        document.getElementById('q-text').innerText = `${currentIdx + 1}. ${q.question}`;
        document.getElementById('page-num').innerText = `${currentIdx + 1} / ${currentQuizSet.length}`;
        const optContainer = document.getElementById('options-container');
        optContainer.innerHTML = "";
        const options = Array.isArray(q.options) ? q.options : Object.values(q.options || {});
        options.forEach((opt, i) => {
            if(!opt) return;
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = `${i + 1}) ${opt}`;
            btn.onclick = () => alert(`ë‹µ: ${i + 1}ë²ˆ ì„ íƒ`);
            optContainer.appendChild(btn);
        });
    }

    window.nextQuestion = () => { if (currentIdx < currentQuizSet.length - 1) { currentIdx++; displayQuestion(); } };
    window.prevQuestion = () => { if (currentIdx > 0) { currentIdx--; displayQuestion(); } };
    window.showMain = () => {
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('quiz-screen').style.display = 'none';
    };
</script>
</body>
</html>